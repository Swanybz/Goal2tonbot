<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>TON Football Championship</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- Monetag Rewarded Interstitial SDK (new) -->
  <script src="https://monetag.com/tag.min.js?zoneid=10656450" data-calculate="true"></script>
  <!-- Monetag Ad SDK -->
  <script src='//libtl.com/sdk.js' data-zone='10656450' data-sdk='show_10656450'></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&amp;family=Rajdhani:wght@400;500;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      overscroll-behavior: none;
      touch-action: pan-x pan-y;
    }
    
    * {
      font-family: 'Rajdhani', sans-serif;
      -webkit-tap-highlight-color: transparent;
    }
    
    .game-title {
      font-family: 'Orbitron', sans-serif;
    }
    
    .field-3d {
      perspective: 800px;
      transform-style: preserve-3d;
    }
    
    .field-surface {
      transform: rotateX(55deg) rotateZ(0deg);
      transform-style: preserve-3d;
      background: linear-gradient(90deg, 
        #1a5c1a 0%, #228b22 8%, #1a5c1a 8%, #1a5c1a 16%, 
        #228b22 16%, #228b22 24%, #1a5c1a 24%, #1a5c1a 32%,
        #228b22 32%, #228b22 40%, #1a5c1a 40%, #1a5c1a 48%,
        #228b22 48%, #228b22 56%, #1a5c1a 56%, #1a5c1a 64%,
        #228b22 64%, #228b22 72%, #1a5c1a 72%, #1a5c1a 80%,
        #228b22 80%, #228b22 88%, #1a5c1a 88%, #1a5c1a 96%,
        #228b22 96%, #228b22 100%);
      box-shadow: 
        0 20px 60px rgba(0,0,0,0.5),
        inset 0 0 100px rgba(0,0,0,0.2);
    }
    
    .field-lines {
      position: absolute;
      inset: 0;
      border: 4px solid rgba(255,255,255,0.9);
      border-radius: 4px;
    }
    
    .center-circle {
      position: absolute;
      width: 80px;
      height: 40px;
      border: 3px solid rgba(255,255,255,0.9);
      border-radius: 50%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    
    .center-line {
      position: absolute;
      width: 100%;
      height: 3px;
      background: rgba(255,255,255,0.9);
      top: 50%;
      transform: translateY(-50%);
    }
    
    .goal-area {
      position: absolute;
      width: 120px;
      height: 40px;
      border: 3px solid rgba(255,255,255,0.9);
      left: 50%;
      transform: translateX(-50%);
    }
    
    .goal-area.top {
      top: 0;
      border-top: none;
    }
    
    .goal-area.bottom {
      bottom: 0;
      border-bottom: none;
    }
    
    .penalty-area {
      position: absolute;
      width: 180px;
      height: 60px;
      border: 3px solid rgba(255,255,255,0.9);
      left: 50%;
      transform: translateX(-50%);
    }
    
    .penalty-area.top {
      top: 0;
      border-top: none;
    }
    
    .penalty-area.bottom {
      bottom: 0;
      border-bottom: none;
    }
    
    .goal-net {
      position: absolute;
      width: 80px;
      height: 20px;
      left: 50%;
      transform: translateX(-50%) translateZ(10px);
      background: repeating-linear-gradient(
        90deg,
        transparent,
        transparent 4px,
        rgba(255,255,255,0.3) 4px,
        rgba(255,255,255,0.3) 5px
      ),
      repeating-linear-gradient(
        0deg,
        transparent,
        transparent 4px,
        rgba(255,255,255,0.3) 4px,
        rgba(255,255,255,0.3) 5px
      );
      border: 3px solid #fff;
      border-radius: 2px;
    }
    
    .goal-net.top {
      top: -22px;
    }
    
    .goal-net.bottom {
      bottom: -22px;
    }
    
    .player {
      position: absolute;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      transform: translate(-50%, -50%) translateZ(20px);
      transition: all 0.15s ease-out;
      cursor: pointer;
      box-shadow: 
        0 4px 8px rgba(0,0,0,0.4),
        0 8px 16px rgba(0,0,0,0.2),
        inset 0 -4px 8px rgba(0,0,0,0.3),
        inset 0 4px 8px rgba(255,255,255,0.3);
    }
    
    .player::before {
      content: '';
      position: absolute;
      width: 10px;
      height: 10px;
      background: radial-gradient(circle at 30% 30%, #ffd7a8, #d4a574);
      border-radius: 50%;
      top: -8px;
      left: 50%;
      transform: translateX(-50%);
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .player::after {
      content: attr(data-number);
      position: absolute;
      font-size: 10px;
      font-weight: bold;
      color: white;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    
    .player.user {
      background: linear-gradient(135deg, #0088cc 0%, #005580 100%);
      border: 3px solid #00aaff;
    }
    
    .player.super {
      background: linear-gradient(135deg, #ffd700 0%, #ff8800 100%);
      border: 3px solid #ffee00;
      animation: superGlow 1s infinite;
    }
    
    .player.ai {
      background: linear-gradient(135deg, #cc2200 0%, #801500 100%);
      border: 3px solid #ff4422;
    }
    
    .player.selected {
      box-shadow: 
        0 0 20px #00ff88,
        0 0 40px #00ff88,
        0 4px 8px rgba(0,0,0,0.4);
      border-color: #00ff88;
      animation: selectedPulse 0.5s infinite;
    }
    
    .ball {
      position: absolute;
      width: 16px;
      height: 16px;
      background: radial-gradient(circle at 30% 30%, #ffffff, #cccccc);
      border-radius: 50%;
      transform: translate(-50%, -50%) translateZ(25px);
      box-shadow: 
        0 4px 8px rgba(0,0,0,0.5),
        inset -2px -2px 4px rgba(0,0,0,0.2);
      transition: all 0.1s linear;
      z-index: 100;
    }
    
    .ball::before {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 20%, transparent 30%, rgba(0,0,0,0.1) 31%),
        conic-gradient(from 0deg, #111 0deg 72deg, transparent 72deg 144deg, 
                       #111 144deg 216deg, transparent 216deg 288deg, #111 288deg 360deg);
      border-radius: 50%;
      opacity: 0.3;
    }
    
    @keyframes superGlow {
      0%, 100% { box-shadow: 0 0 20px #ffd700, 0 0 40px #ff8800; }
      50% { box-shadow: 0 0 30px #ffd700, 0 0 60px #ff8800; }
    }
    
    @keyframes selectedPulse {
      0%, 100% { transform: translate(-50%, -50%) translateZ(20px) scale(1.1); }
      50% { transform: translate(-50%, -50%) translateZ(20px) scale(1.15); }
    }
    
    @keyframes goalCelebration {
      0% { transform: scale(1); }
      25% { transform: scale(1.5) rotate(10deg); }
      50% { transform: scale(1.3) rotate(-10deg); }
      75% { transform: scale(1.4) rotate(5deg); }
      100% { transform: scale(1); }
    }
    
    @keyframes confetti {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(300px) rotate(720deg); opacity: 0; }
    }
    
    @keyframes varScan {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }
    
    .goal-celebration {
      animation: goalCelebration 1s ease-in-out;
    }
    
    .confetti-piece {
      position: absolute;
      width: 10px;
      height: 10px;
      animation: confetti 2s ease-out forwards;
    }
    
    .btn-3d {
      transform: translateY(0);
      transition: all 0.1s ease;
      box-shadow: 
        0 6px 0 #004466,
        0 8px 10px rgba(0,0,0,0.3);
    }
    
    .btn-3d:hover {
      transform: translateY(2px);
      box-shadow: 
        0 4px 0 #004466,
        0 6px 8px rgba(0,0,0,0.3);
    }
    
    .btn-3d:active {
      transform: translateY(4px);
      box-shadow: 
        0 2px 0 #004466,
        0 4px 6px rgba(0,0,0,0.3);
    }
    
    .stat-card {
      background: linear-gradient(135deg, rgba(0,136,204,0.2), rgba(0,85,128,0.3));
      border: 1px solid rgba(0,170,255,0.3);
      backdrop-filter: blur(10px);
    }
    
    .joystick-container {
      width: 120px;
      height: 120px;
      background: radial-gradient(circle, #1a1a2e 0%, #0d0d1a 100%);
      border-radius: 50%;
      border: 4px solid #0088cc;
      position: relative;
      box-shadow: 
        inset 0 0 20px rgba(0,136,204,0.3),
        0 4px 15px rgba(0,0,0,0.5);
      touch-action: none;
      user-select: none;
    }
    
    .joystick-knob {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #0088cc, #005580);
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      cursor: grab;
      box-shadow: 
        0 4px 10px rgba(0,0,0,0.4),
        inset 0 2px 10px rgba(255,255,255,0.2);
      transition: transform 0.1s ease-out;
      pointer-events: none;
    }
    
    .action-btn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      font-weight: bold;
      font-size: 11px;
      text-transform: uppercase;
      box-shadow: 
        0 4px 0 rgba(0,0,0,0.3),
        0 6px 10px rgba(0,0,0,0.3),
        inset 0 2px 10px rgba(255,255,255,0.2);
      transition: all 0.1s ease;
      touch-action: none;
      user-select: none;
    }
    
    .action-btn:active, .action-btn.pressed {
      transform: translateY(3px);
      box-shadow: 
        0 1px 0 rgba(0,0,0,0.3),
        0 3px 6px rgba(0,0,0,0.3);
    }
    
    .kick-btn {
      background: linear-gradient(135deg, #ff6b35, #cc4400);
      border: 3px solid #ff8855;
    }
    
    .pass-btn {
      background: linear-gradient(135deg, #00cc66, #009944);
      border: 3px solid #00ff88;
    }
    
    .sprint-btn {
      background: linear-gradient(135deg, #ffcc00, #cc9900);
      border: 3px solid #ffdd44;
    }
    
    .energy-bar {
      height: 8px;
      background: linear-gradient(90deg, #ff3333, #ffcc00, #00ff66);
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    
    .celebration-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .celebration-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }
    
    .celebration-content {
      text-align: center;
      transform: scale(0);
      transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    
    .celebration-overlay.active .celebration-content {
      transform: scale(1);
    }
    
    .var-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 500;
      animation: varScan 2s ease-in-out;
    }
    
    .screen {
      display: none;
    }
    
    .screen.active {
      display: flex;
    }
    
    .leaderboard-entry {
      transition: all 0.3s ease;
    }
    
    .leaderboard-entry:hover {
      transform: translateX(5px);
      background: rgba(0,136,204,0.2);
    }
    
    .ton-logo {
      width: 24px;
      height: 24px;
      display: inline-block;
    }
    
    .ton-logo-big {
      width: 48px;
      height: 48px;
    }
    
    @keyframes pulse-ring {
      0% {
        box-shadow: 0 0 0 0 rgba(0,255,136,0.7);
      }
      100% {
        box-shadow: 0 0 0 20px rgba(0,255,136,0);
      }
    }
    
    .pulse-animation {
      animation: pulse-ring 1.5s infinite;
    }
    
    .locked-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
      z-index: 100;
    }
    
    .scroll-container {
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .referral-code-box {
      background: linear-gradient(135deg, #0088cc, #005580);
      border: 2px dashed #00aaff;
      font-family: 'Orbitron', monospace;
      letter-spacing: 2px;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 text-white overflow-auto">
  <!-- All existing screens (menu-screen, game-screen, etc.) remain exactly the same -->
  <div id="menu-screen" class="screen active flex-col items-center justify-center min-h-full p-6">
   <div class="text-center mb-6">
    <svg class="w-24 h-24 mx-auto mb-4" viewbox="0 0 100 100"><defs>
      <lineargradient id="tonGrad" x1="0%" y1="0%" x2="100%" y2="100%">
       <stop offset="0%" style="stop-color:#0088CC" />
       <stop offset="50%" style="stop-color:#229ED9" />
       <stop offset="100%" style="stop-color:#0088CC" />
      </lineargradient>
      <radialgradient id="shine">
       <stop offset="0%" style="stop-color:#fff;stop-opacity:0.8" />
       <stop offset="100%" style="stop-color:#fff;stop-opacity:0" />
      </radialgradient>
     </defs> <circle cx="50" cy="50" r="48" fill="url(#tonGrad)" stroke="#00AAFF" stroke-width="2" /> <ellipse cx="35" cy="35" rx="15" ry="12" fill="url(#shine)" opacity="0.4" /> <text x="50" y="42" text-anchor="middle" fill="white" font-size="18" font-weight="900" font-family="Arial">
      TON
     </text> <path d="M 30 55 L 70 55 M 30 62 L 70 62 M 30 69 L 70 69" stroke="white" stroke-width="3" opacity="0.3" />
    </svg>
    <h1 id="main-title" class="game-title text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 via-blue-400 to-cyan-400 mb-2">TON FOOTBALL</h1>
    <p id="welcome-msg" class="text-cyan-300 text-sm">Play &amp; Earn Real TON Crypto</p>
    <p class="text-gray-500 text-xs mt-1">1 TON ‚âà $5.20 USD</p>
   </div>

   <!-- Force Join Channel Banner (shown if not joined) -->
   <div id="join-channel-banner" class="hidden w-full max-w-sm mb-4 p-4 bg-gradient-to-r from-purple-600 to-pink-600 rounded-xl text-center">
    <p class="font-bold mb-2">üî• Join our channel to play!</p>
    <a href="https://t.me/Goal2Ton_payout" target="_blank" class="inline-block px-4 py-2 bg-white text-purple-700 rounded-lg font-semibold mb-2">Join @Goal2Ton_payout</a>
    <button onclick="verifyChannelJoin()" class="w-full mt-2 py-2 bg-green-500 hover:bg-green-600 rounded-lg font-semibold">I've Joined ‚Äì Verify</button>
   </div>

   <div class="stat-card rounded-2xl p-4 mb-6 w-full max-w-sm">
    <div class="grid grid-cols-2 gap-3 mb-3">
     <div class="text-center">
      <div class="flex items-center justify-center gap-1 mb-1">
       <svg class="ton-logo" viewbox="0 0 100 100"><circle cx="50" cy="50" r="48" fill="url(#tonGrad)" stroke="#00AAFF" stroke-width="2" /> <text x="50" y="60" text-anchor="middle" fill="white" font-size="32" font-weight="900">
         T
        </text>
       </svg><span id="menu-coins" class="text-2xl font-bold text-cyan-400">0.0000</span>
      </div><span class="text-gray-400 text-xs">TON Balance</span>
     </div>
     <div class="text-center">
      <div class="flex items-center justify-center gap-2 mb-1"><span class="text-xl">‚ö°</span> <span id="menu-energy" class="text-2xl font-bold text-yellow-400">100</span>
      </div><span class="text-gray-400 text-xs">Energy</span>
     </div>
    </div>
    <!-- New row for Goal Points -->
    <div class="flex justify-center items-center gap-2 mb-2">
     <span class="text-xl">‚öΩ</span>
     <span id="menu-goalpoints" class="text-xl font-bold text-green-400">0</span>
     <span class="text-gray-400 text-xs">GP</span>
    </div>
    <div class="grid grid-cols-3 gap-2 text-center text-xs">
     <div>
      <div id="menu-wins" class="font-bold text-green-400">
       0
      </div>
      <div class="text-gray-500">
       Wins
      </div>
     </div>
     <div>
      <div id="menu-draws" class="font-bold text-yellow-400">
       0
      </div>
      <div class="text-gray-500">
       Draws
      </div>
     </div>
     <div>
      <div id="menu-losses" class="font-bold text-red-400">
       0
      </div>
      <div class="text-gray-500">
       Losses
      </div>
     </div>
    </div>
   </div>
   <div class="space-y-3 w-full max-w-sm mb-4">
    <button onclick="checkAndStartGame()" id="play-btn" class="btn-3d w-full py-4 bg-gradient-to-r from-cyan-500 to-blue-600 rounded-xl font-bold text-xl uppercase tracking-wider"> ‚öΩ Play Match </button>
    <button onclick="showScreen('referral-screen')" class="w-full py-3 bg-gradient-to-r from-pink-500 to-rose-600 hover:from-pink-600 hover:to-rose-700 rounded-xl font-semibold transition-all pulse-animation"> üë• Invite Friends (+0.0001 TON +25‚ö°) </button>
    <button onclick="showScreen('upgrade-screen')" class="w-full py-3 bg-gradient-to-r from-purple-500 to-violet-600 hover:from-purple-600 hover:to-violet-700 rounded-xl font-semibold transition-all"> ‚ö° Upgrade Players </button>
    <button onclick="showScreen('leaderboard-screen')" class="w-full py-3 bg-gradient-to-r from-yellow-500 to-orange-600 hover:from-yellow-600 hover:to-orange-700 rounded-xl font-semibold transition-all"> üèÜ Leaderboard </button>
    <button onclick="showScreen('wallet-screen')" class="w-full py-3 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 rounded-xl font-semibold transition-all"> üí∞ TON Wallet </button>
    <!-- Music Toggle Button -->
    <button onclick="toggleMusic()" id="music-toggle-btn" class="w-full py-3 bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 rounded-xl font-semibold transition-all"> üéµ Music: ON </button>
   </div>
   <div class="text-center text-xs text-gray-500">
    <p>üì∫ Watch ads: <span id="menu-ads">0</span>/10 for bonus</p>
    <p class="mt-1">üë• Referrals: <span id="menu-referrals">0</span></p>
   </div>
  </div>

  <!-- Game Screen (unchanged) -->
  <div id="game-screen" class="screen flex-col h-full">
   <div class="flex-shrink-0 bg-gradient-to-b from-slate-900/95 to-transparent p-3">
    <div class="flex items-center justify-between max-w-lg mx-auto">
     <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center font-bold">
       YOU
      </div><span id="user-score" class="text-3xl font-black">0</span>
     </div>
     <div class="text-center">
      <div id="game-timer" class="text-2xl font-bold text-cyan-400">
       3:00
      </div>
      <div class="text-xs text-gray-400">
       TIME
      </div>
     </div>
     <div class="flex items-center gap-3">
      <span id="ai-score" class="text-3xl font-black">0</span>
      <div id="ai-team-badge" class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-600 to-pink-600 flex items-center justify-center font-bold text-xs">G2T</div>
     </div>
    </div>
    <div class="flex items-center justify-between max-w-lg mx-auto mt-2 text-xs">
     <div class="flex items-center gap-1">
      <svg class="ton-logo" viewbox="0 0 100 100"><circle cx="50" cy="50" r="48" fill="url(#tonGrad)" /> <text x="50" y="60" text-anchor="middle" fill="white" font-size="32" font-weight="900">
        T
       </text>
      </svg><span id="game-coins" class="font-bold text-cyan-400">0.0000</span>
     </div>
     <div class="flex items-center gap-2"><span class="text-yellow-400">‚ö°</span>
      <div class="w-20 bg-gray-700 rounded-full h-2">
       <div id="energy-bar" class="energy-bar" style="width: 100%"></div>
      </div><span id="energy-text" class="text-yellow-400 font-bold">100</span>
     </div>
    </div>
   </div>
   <div class="flex-1 flex items-center justify-center p-2 overflow-hidden">
    <div class="field-3d w-full max-w-md">
     <div id="field" class="field-surface relative w-full aspect-[3/4] rounded-lg mx-auto">
      <div class="field-lines">
       <div class="center-line"></div>
       <div class="center-circle"></div>
       <div class="penalty-area top"></div>
       <div class="penalty-area bottom"></div>
       <div class="goal-area top"></div>
       <div class="goal-area bottom"></div>
       <div class="goal-net top"></div>
       <div class="goal-net bottom"></div>
      </div>
      <div id="ball" class="ball" style="left: 50%; top: 50%;"></div>
     </div>
    </div>
   </div>
   <div class="flex-shrink-0 bg-gradient-to-t from-slate-900 to-transparent p-4">
    <div class="flex items-center justify-between max-w-lg mx-auto">
     <div id="joystick" class="joystick-container">
      <div id="joystick-knob" class="joystick-knob"></div>
     </div>
     <div class="flex flex-col gap-3">
      <div class="flex gap-3"><button id="btn-kick" class="action-btn kick-btn text-white">
        <div>
         ‚öΩ
        </div>
        <div style="font-size: 9px;">
         KICK
        </div></button> <button id="btn-pass" class="action-btn pass-btn text-white">
        <div>
         üéØ
        </div>
        <div style="font-size: 9px;">
         PASS
        </div></button>
      </div><button id="btn-sprint" class="action-btn sprint-btn text-white mx-auto">
       <div>
        ‚ö°
       </div>
       <div style="font-size: 9px;">
        SPRINT
       </div></button>
     </div>
    </div><button onclick="endGame()" class="mt-4 px-6 py-2 bg-red-500/20 hover:bg-red-500/40 rounded-lg text-red-400 text-sm mx-auto block transition-all"> End Match </button>
   </div>
  </div>

  <!-- Referral Screen (unchanged) -->
  <div id="referral-screen" class="screen flex-col min-h-full p-6 scroll-container">
   <div class="flex items-center gap-4 mb-6"><button onclick="showScreen('menu-screen')" class="p-2 bg-white/10 rounded-lg hover:bg-white/20 transition-all">
     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
     </svg></button>
    <h2 class="game-title text-2xl font-bold">üë• Invite Friends</h2>
   </div>
   <div class="stat-card rounded-xl p-6 mb-6 text-center">
    <div class="text-5xl mb-3">
     üéÅ
    </div>
    <h3 class="text-2xl font-bold mb-2">Earn TON by Inviting!</h3>
    <p class="text-gray-400 text-sm mb-4">Get 0.0001 TON + 25 Energy for each friend who joins</p>
    <div class="grid grid-cols-2 gap-4">
     <div>
      <div class="flex items-center justify-center gap-1 mb-1">
       <svg class="ton-logo" viewbox="0 0 100 100"><circle cx="50" cy="50" r="48" fill="url(#tonGrad)" /> <text x="50" y="60" text-anchor="middle" fill="white" font-size="32" font-weight="900">
         T
        </text>
       </svg><span id="referral-earnings" class="text-2xl font-bold text-cyan-400">0.0000</span>
      </div>
      <div class="text-xs text-gray-400">
       Total Earned
      </div>
     </div>
     <div>
      <div class="text-3xl font-bold text-pink-400" id="referral-count">
       0
      </div>
      <div class="text-xs text-gray-400">
       Friends Joined
      </div>
     </div>
    </div>
   </div>
   <div class="stat-card rounded-xl p-5 mb-4"><label class="block text-sm font-semibold mb-2">Your Referral Code</label>
    <div class="referral-code-box rounded-lg p-4 text-center mb-3">
     <div id="my-referral-code" class="text-3xl font-black text-white tracking-wider">
      LOADING...
     </div>
    </div><button onclick="copyReferralCode()" class="w-full py-3 bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-600 hover:to-blue-700 rounded-lg font-bold transition-all"> üìã Copy Code </button>
   </div>
   <div class="stat-card rounded-xl p-5 mb-4"><label class="block text-sm font-semibold mb-2">Share on Telegram</label>
    <p class="text-xs text-gray-400 mb-3">Send your referral link directly to friends</p><button onclick="shareToTelegram()" class="w-full py-3 bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 rounded-lg font-bold transition-all flex items-center justify-center gap-2">
     <svg class="w-5 h-5" fill="currentColor" viewbox="0 0 24 24"><path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.446 1.394c-.14.18-.357.295-.6.295-.002 0-.003 0-.005 0l.213-3.054 5.56-5.022c.24-.213-.054-.334-.373-.121l-6.869 4.326-2.96-.924c-.64-.203-.658-.64.135-.954l11.566-4.458c.538-.196 1.006.128.832.941z" />
     </svg> Share to Telegram </button>
   </div>
   <div class="stat-card rounded-xl p-5 mb-4"><label class="block text-sm font-semibold mb-2">Copy Invitation Link</label>
    <div class="flex gap-2"><input type="text" id="referral-link-input" readonly class="flex-1 bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-white text-xs" value="Loading..."> <button onclick="copyReferralLink()" class="px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-600 rounded-lg font-bold text-sm whitespace-nowrap"> Copy </button>
    </div>
   </div>
   <div id="referral-input-section" class="stat-card rounded-xl p-5"><label class="block text-sm font-semibold mb-2">Have a Referral Code?</label>
    <p class="text-xs text-gray-400 mb-3">Enter your friend's code to get bonus energy</p>
    <div class="flex gap-2"><input type="text" id="referral-code-input" placeholder="Enter code (e.g., TON1234ABC)" class="flex-1 bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white uppercase" maxlength="11"> <button onclick="submitReferralCode()" class="px-4 py-3 bg-gradient-to-r from-pink-500 to-rose-600 rounded-lg font-bold text-sm whitespace-nowrap"> Submit </button>
    </div>
    <p id="referral-submit-message" class="text-xs mt-2"></p>
   </div>
  </div>

  <!-- Leaderboard Screen (unchanged) -->
  <div id="leaderboard-screen" class="screen flex-col min-h-full p-6">
   <div class="flex items-center gap-4 mb-6"><button onclick="showScreen('menu-screen')" class="p-2 bg-white/10 rounded-lg hover:bg-white/20 transition-all">
     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
     </svg></button>
    <h2 class="game-title text-2xl font-bold">üèÜ Leaderboard</h2>
   </div>
   <div class="stat-card rounded-xl p-4 mb-4">
    <div class="flex items-center justify-between">
     <div>
      <div class="text-sm text-gray-400 mb-1">
       Your Rank
      </div>
      <div id="user-rank" class="text-3xl font-black text-cyan-400">
       #-
      </div>
     </div>
     <div class="text-right">
      <div class="text-sm text-gray-400 mb-1">
       Your Score
      </div>
      <div class="flex items-center gap-1 justify-end">
       <svg class="ton-logo" viewbox="0 0 100 100"><circle cx="50" cy="50" r="48" fill="url(#tonGrad)" /> <text x="50" y="60" text-anchor="middle" fill="white" font-size="32" font-weight="900">
         T
        </text>
       </svg><span id="user-leaderboard-coins" class="text-2xl font-bold text-cyan-400">0.0000</span>
      </div>
     </div>
    </div>
   </div>
   <div id="leaderboard-list" class="space-y-2 scroll-container" style="max-height: 60vh;"></div>
  </div>

  <!-- Upgrade Screen (costs now in GP) -->
  <div id="upgrade-screen" class="screen flex-col min-h-full p-6 scroll-container">
   <div class="flex items-center gap-4 mb-6"><button onclick="showScreen('menu-screen')" class="p-2 bg-white/10 rounded-lg hover:bg-white/20 transition-all">
     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
     </svg></button>
    <h2 class="game-title text-2xl font-bold">‚ö° Upgrades</h2>
   </div>
   <div class="stat-card rounded-xl p-4 mb-4 text-center">
    <div class="flex items-center justify-center gap-2 mb-2">
     <svg class="ton-logo-big" viewbox="0 0 100 100"><circle cx="50" cy="50" r="48" fill="url(#tonGrad)" stroke="#00AAFF" stroke-width="2" /> <text x="50" y="60" text-anchor="middle" fill="white" font-size="32" font-weight="900">
       T
      </text>
     </svg><span id="upgrade-balance" class="text-4xl font-black text-cyan-400">0.0000</span>
    </div>
    <div class="text-sm text-gray-400">
     Available TON
    </div>
    <div class="flex items-center justify-center gap-2 mt-2">
     <span class="text-xl">‚öΩ</span>
     <span id="upgrade-gp" class="text-2xl font-bold text-green-400">0</span>
     <span class="text-sm text-gray-400">GP</span>
    </div>
   </div>
   <div class="space-y-4">
    <div class="stat-card rounded-xl p-5">
     <div class="flex items-center gap-4 mb-3">
      <div class="w-16 h-16 rounded-xl bg-gradient-to-br from-yellow-500 to-orange-600 flex items-center justify-center text-3xl">
       ‚ö°
      </div>
      <div class="flex-1">
       <h3 class="font-bold text-lg">Energy Boost</h3>
       <p class="text-sm text-gray-400">Increase max energy to 150</p>
      </div>
     </div>
     <div class="flex items-center justify-between">
      <div class="flex items-center gap-1">
       <span class="text-xl">‚öΩ</span><span class="font-bold text-green-400">1000</span>
      </div><button onclick="upgradeEnergy()" id="btn-upgrade-energy" class="px-4 py-2 bg-gradient-to-r from-yellow-500 to-orange-600 rounded-lg font-bold text-sm"> Upgrade </button>
     </div>
    </div>
    <div class="stat-card rounded-xl p-5">
     <div class="flex items-center gap-4 mb-3">
      <div class="w-16 h-16 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center text-3xl">
       üéØ
      </div>
      <div class="flex-1">
       <h3 class="font-bold text-lg">Player Skills</h3>
       <p class="text-sm text-gray-400">Level <span id="player-level">1</span> - Better accuracy</p>
      </div>
     </div>
     <div class="flex items-center justify-between">
      <div class="flex items-center gap-1">
       <span class="text-xl">‚öΩ</span><span id="level-cost" class="font-bold text-green-400">1500</span>
      </div><button onclick="upgradeLevel()" id="btn-upgrade-level" class="px-4 py-2 bg-gradient-to-r from-cyan-500 to-blue-600 rounded-lg font-bold text-sm"> Upgrade </button>
     </div>
    </div>
    <div class="stat-card rounded-xl p-5 relative">
     <div class="flex items-center gap-4 mb-3">
      <div class="w-16 h-16 rounded-xl bg-gradient-to-br from-yellow-400 to-orange-500 flex items-center justify-center text-3xl">
       ‚≠ê
      </div>
      <div class="flex-1">
       <h3 class="font-bold text-lg">Super Player</h3>
       <p class="text-sm text-gray-400">Unlock golden striker with special abilities</p>
      </div>
     </div>
     <div class="flex items-center justify-between">
      <div class="flex items-center gap-1">
       <span class="text-xl">‚öΩ</span><span class="font-bold text-green-400">5000</span>
      </div><button onclick="unlockSuperPlayer()" id="btn-super-player" class="px-4 py-2 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-lg font-bold text-sm"> Unlock </button>
     </div>
     <div id="super-locked" class="hidden locked-overlay rounded-xl">
      <div class="text-center">
       <div class="text-4xl mb-2">
        üîí
       </div>
       <div class="text-sm font-bold">
        UNLOCKED!
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>

  <!-- Wallet Screen (updated with GP conversion) -->
  <div id="wallet-screen" class="screen flex-col min-h-full p-6 scroll-container">
   <div class="flex items-center gap-4 mb-6"><button onclick="showScreen('menu-screen')" class="p-2 bg-white/10 rounded-lg hover:bg-white/20 transition-all">
     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
     </svg></button>
    <h2 class="game-title text-2xl font-bold">üí∞ TON Wallet</h2>
   </div>
   <div class="stat-card rounded-xl p-6 mb-6 text-center">
    <svg class="ton-logo-big mx-auto mb-3" viewbox="0 0 100 100"><circle cx="50" cy="50" r="48" fill="url(#tonGrad)" stroke="#00AAFF" stroke-width="2" /> <ellipse cx="35" cy="35" rx="15" ry="12" fill="url(#shine)" opacity="0.4" /> <text x="50" y="60" text-anchor="middle" fill="white" font-size="32" font-weight="900">
      T
     </text>
    </svg>
    <div id="wallet-balance" class="text-4xl font-black text-cyan-400 mb-2">0.0000</div>
    <div class="text-sm text-gray-400 mb-1">TON Balance</div>
    <div class="text-xs text-gray-500">‚âà $<span id="wallet-usd">0.00</span> USD</div>
    <div class="flex items-center justify-center gap-2 mt-4">
     <span class="text-xl">‚öΩ</span>
     <span id="wallet-gp" class="text-2xl font-bold text-green-400">0</span>
     <span class="text-sm text-gray-400">Goal Points</span>
    </div>
    <button onclick="showConvertModal()" class="mt-4 px-4 py-2 bg-gradient-to-r from-yellow-500 to-orange-600 rounded-lg font-bold text-sm"> Convert GP to TON </button>
   </div>
   <div class="mb-6"><label class="block text-sm font-semibold mb-2">Your TON Wallet Address</label>
    <div class="flex gap-2"><input type="text" id="wallet-input" placeholder="UQxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" class="flex-1 bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white text-sm"> <button onclick="saveWalletAddress()" class="px-4 py-3 bg-gradient-to-r from-green-500 to-emerald-600 rounded-lg font-bold text-sm whitespace-nowrap"> Save </button>
    </div>
    <p id="wallet-status" class="text-xs mt-2 text-gray-400"></p>
   </div>
   <div class="stat-card rounded-xl p-5 mb-4">
    <h3 class="font-bold mb-3">Withdrawal Info</h3>
    <div class="space-y-2 text-sm">
     <div class="flex justify-between"><span class="text-gray-400">Minimum:</span> <span class="font-bold">0.0500 TON</span></div>
     <div class="flex justify-between"><span class="text-gray-400">Daily Limit:</span> <span class="font-bold">0.1000 TON</span></div>
     <div class="flex justify-between"><span class="text-gray-400">Today withdrawn:</span> <span id="daily-withdrawn" class="font-bold text-yellow-400">0.0000</span></div>
     <div class="flex justify-between"><span class="text-gray-400">Network Fee:</span> <span class="font-bold">0.0001 TON</span></div>
    </div>
   </div><button onclick="showWithdrawModal()" id="btn-withdraw" class="w-full py-4 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 rounded-xl font-bold uppercase tracking-wider transition-all" disabled> üí∏ Withdraw TON </button>
   <p class="text-xs text-center text-gray-500 mt-2">Wallet address required to withdraw</p>
   <div class="mt-6 p-4 bg-blue-500/10 border border-blue-500/30 rounded-lg">
    <p class="text-xs text-blue-300"><strong>Note:</strong> Convert Goal Points (GP) to TON before withdrawing. 1000 GP = 0.01 TON.</p>
   </div>
  </div>

  <!-- Convert GP Modal -->
  <div id="convert-modal" class="celebration-overlay">
   <div class="celebration-content stat-card rounded-2xl p-8 max-w-sm mx-4" style="transform: scale(1);">
    <div class="text-6xl mb-4">‚öΩ</div>
    <h2 class="game-title text-2xl font-bold mb-4">Convert GP to TON</h2>
    <div class="bg-white/10 rounded-xl p-4 mb-6">
     <div class="text-sm text-gray-400 mb-2">Your Goal Points</div>
     <div class="flex items-center justify-center gap-2">
      <span class="text-4xl font-black text-green-400" id="convert-gp-balance">0</span>
     </div>
    </div>
    <div class="mb-6"><label for="convert-amount" class="block text-sm text-gray-400 mb-2">Amount (GP)</label>
     <div class="flex gap-2"><input type="number" id="convert-amount" step="100" min="1000" class="flex-1 bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white text-center text-xl font-bold" placeholder="1000"> <button onclick="setMaxConvert()" class="px-4 py-3 bg-cyan-500/20 hover:bg-cyan-500/30 rounded-lg text-cyan-400 font-bold transition-all"> MAX </button>
     </div>
     <p class="text-xs text-gray-500 mt-2">Min: 1000 GP = 0.01 TON</p>
    </div>
    <div class="space-y-3"><button onclick="processConvert()" class="w-full py-3 bg-gradient-to-r from-yellow-500 to-orange-600 hover:from-yellow-600 hover:to-orange-700 rounded-xl font-bold uppercase transition-all"> Convert </button> <button onclick="closeConvertModal()" class="w-full py-3 bg-white/10 hover:bg-white/20 rounded-xl font-semibold transition-all"> Cancel </button>
    </div>
    <div id="convert-message" class="mt-4 p-3 rounded-lg hidden"></div>
   </div>
  </div>

  <!-- VAR, Celebration, Game Over, Ad, Withdraw modals unchanged -->
  <div id="var-overlay" class="celebration-overlay">...</div>
  <div id="celebration-overlay" class="celebration-overlay">...</div>
  <div id="gameover-overlay" class="celebration-overlay">...</div>
  <div id="ad-screen" class="celebration-overlay">...</div>
  <div id="withdraw-modal" class="celebration-overlay">...</div>

  <script>
    // Global error handler
    window.onerror = function(msg, url, line) {
      console.error('Global error:', msg, 'at', url, 'line', line);
      return true;
    };

    // -------------------- Sound System (unchanged) --------------------
    let audioCtx = null;
    let musicInterval = null;
    let musicEnabled = true;

    function initAudio() {
      if (!audioCtx) {
        try {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        } catch(e) { console.warn('Web Audio API not supported'); }
      }
    }

    function playSound(type) {
      if (!audioCtx) initAudio();
      if (!audioCtx) return;
      if (audioCtx.state === 'suspended') audioCtx.resume().catch(e => {});
      try {
        const now = audioCtx.currentTime;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        switch(type) {
          case 'kick':
            osc.frequency.setValueAtTime(200, now);
            osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
            gain.gain.setValueAtTime(1, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc.stop(now + 0.1); break;
          case 'pass':
            osc.frequency.setValueAtTime(400, now);
            osc.frequency.exponentialRampToValueAtTime(300, now + 0.08);
            gain.gain.setValueAtTime(0.8, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.08);
            osc.stop(now + 0.08); break;
          case 'goal':
            [0,0.3,0.6,0.9,1.2].forEach((t,i) => osc.frequency.setValueAtTime([440,540,640,740,840][i], now+t));
            gain.gain.setValueAtTime(0.7, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 1.5);
            osc.stop(now + 1.5); break;
          case 'whistle':
            osc.frequency.setValueAtTime(800, now);
            osc.frequency.linearRampToValueAtTime(1200, now + 0.15);
            gain.gain.setValueAtTime(1, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
            osc.stop(now + 0.3); break;
          case 'coin':
            osc.frequency.setValueAtTime(800, now);
            osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
            gain.gain.setValueAtTime(0.8, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc.stop(now + 0.1); break;
          default: return;
        }
        osc.start(now);
      } catch(e) {}
    }

    function playBackgroundMusic() {
      if (!musicEnabled) return;
      if (!audioCtx) initAudio();
      if (!audioCtx) return;
      if (audioCtx.state === 'suspended') audioCtx.resume().catch(e => {});
      const notes = [261.63,293.66,329.63,349.23,392.00,440.00,493.88,523.25];
      let index = 0;
      function playNext() {
        if (!musicEnabled) return;
        try {
          const now = audioCtx.currentTime;
          const osc = audioCtx.createOscillator();
          const gain = audioCtx.createGain();
          osc.connect(gain);
          gain.connect(audioCtx.destination);
          osc.frequency.value = notes[index % notes.length];
          gain.gain.setValueAtTime(0.5, now);
          gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
          osc.start(now);
          osc.stop(now + 0.5);
          index++;
        } catch(e) {}
      }
      if (musicInterval) clearInterval(musicInterval);
      musicInterval = setInterval(playNext, 600);
    }

    function toggleMusic() {
      musicEnabled = !musicEnabled;
      const btn = document.getElementById('music-toggle-btn');
      if (btn) btn.textContent = musicEnabled ? 'üéµ Music: ON' : 'üéµ Music: OFF';
      if (musicEnabled) playBackgroundMusic();
      else { if (musicInterval) { clearInterval(musicInterval); musicInterval = null; } }
    }

    // -------------------- LocalStorage --------------------
    const STORAGE_KEY_USERS = 'ton_football_users';
    const STORAGE_KEY_CURRENT_USER = 'ton_football_current_user';

    function loadAllUsers() {
      const data = localStorage.getItem(STORAGE_KEY_USERS);
      return data ? JSON.parse(data) : [];
    }
    function saveAllUsers(users) {
      localStorage.setItem(STORAGE_KEY_USERS, JSON.stringify(users));
    }
    function getCurrentUserId() {
      return localStorage.getItem(STORAGE_KEY_CURRENT_USER);
    }
    function setCurrentUserId(id) {
      localStorage.setItem(STORAGE_KEY_CURRENT_USER, id);
    }
    function getUserById(id) {
      const users = loadAllUsers();
      return users.find(u => u.id === id) || null;
    }
    function updateUser(userData) {
      const users = loadAllUsers();
      const index = users.findIndex(u => u.id === userData.id);
      if (index >= 0) users[index] = { ...users[index], ...userData };
      else users.push(userData);
      saveAllUsers(users);
      if (userData.id === getCurrentUserId()) {
        playerData = userData;
        updateStatsDisplay();
        updateLeaderboard();
        updateReferralDisplay();
      }
    }

    // -------------------- Telegram & Webhook --------------------
    const tg = window.Telegram?.WebApp;
    if (tg) { tg.ready(); tg.expand(); }

    const urlParams = new URLSearchParams(window.location.search);
    const BJS_WEBHOOK = urlParams.get('webhook');
    const REFERRER_PARAM = urlParams.get('start'); // referrer ID
    const JOINED_PARAM = urlParams.get('joined');

    let currentUserId = getCurrentUserId();
    if (!currentUserId) {
      const tgUser = tg?.initDataUnsafe?.user;
      currentUserId = tgUser?.id ? String(tgUser.id) : 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2,9);
      setCurrentUserId(currentUserId);
    }

    let playerData = getUserById(currentUserId);
    if (!playerData) {
      playerData = {
        id: currentUserId,
        username: tg?.initDataUnsafe?.user?.username || 'Player',
        first_name: tg?.initDataUnsafe?.user?.first_name || 'Player',
        wallet_address: '',
        total_coins: 0,          // TON balance
        goal_points: 0,           // GP balance
        goals_scored: 0,
        games_played: 0,
        wins: 0, losses: 0, draws: 0,
        high_score: 0,
        ads_watched: 0,
        player_energy: 100,
        player_level: 1,
        super_player_unlocked: false,
        referral_code: currentUserId,
        referred_by: '',
        referral_count: 0,
        referral_earnings: 0,
        joined_channel: false,
        daily_withdrawn: 0,
        last_withdraw_date: '',
        created_at: new Date().toISOString(),
        last_played: new Date().toISOString()
      };
      updateUser(playerData);
    }

    if (JOINED_PARAM === '1') {
      playerData.joined_channel = true;
      updateUser(playerData);
    }

    // Store referrer from URL for validation
    let incomingReferrerId = (REFERRER_PARAM && REFERRER_PARAM !== playerData.id) ? REFERRER_PARAM : null;

    if (incomingReferrerId) {
      // Silently store for later validation
      // But do not apply bonus yet ‚Äì user must submit code to claim
    }

    async function sendToBot(eventType, data = {}) {
      if (!BJS_WEBHOOK) return null;
      const payload = {
        event: eventType,
        user_id: playerData.id,
        username: playerData.username,
        first_name: playerData.first_name,
        ...data,
        timestamp: Date.now()
      };
      try {
        const response = await fetch(BJS_WEBHOOK, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (response.ok) return await response.json();
      } catch (e) { console.warn('Webhook send failed', e); }
      return null;
    }

    // -------------------- Channel join --------------------
    let joinedChannel = playerData.joined_channel || false;
    if (!joinedChannel) document.getElementById('join-channel-banner').classList.remove('hidden');
    else document.getElementById('join-channel-banner').classList.add('hidden');

    async function verifyChannelJoin() {
      showInlineMessage('Verifying...', 'info');
      const response = await sendToBot('verify_channel', {});
      if (response && response.joined === true) {
        joinedChannel = true;
        playerData.joined_channel = true;
        updateUser(playerData);
        document.getElementById('join-channel-banner').classList.add('hidden');
        showInlineMessage('‚úÖ Channel joined verified! You can now play.', 'success');
        updateStatsDisplay();
      } else {
        showInlineMessage('‚ùå Not a member yet. Please join the channel first.', 'error');
      }
    }

    // -------------------- Constants --------------------
    const TON_USD_RATE = 5.20;
    const GOAL_GP = 100;                // GP per goal
    const AD_GP_BONUS = 200;             // GP bonus for watching ad
    const REFERRAL_TON = 0.0001;
    const REFERRAL_ENERGY = 25;
    const WIN_BONUS_GP = 200;             // GP bonus for winning
    const MATCH_DURATION = 180;
    const ENERGY_COST_PER_MATCH = 15;
    const AD_DURATION = 30;
    const MAX_ENERGY = 100;
    const ENERGY_BOOST_COST_GP = 1000;
    const LEVEL_UP_BASE_COST_GP = 1500;
    const SUPER_PLAYER_COST_GP = 5000;
    const GP_TO_TON_RATE = 1000;          // 1000 GP = 0.01 TON
    const MIN_WITHDRAW_TON = 0.05;
    const DAILY_LIMIT_TON = 0.10;
    const WITHDRAW_FEE = 0.0001;

    const defaultConfig = {
      game_title: 'TON FOOTBALL',
      welcome_message: 'Play & Earn Real TON Crypto'
    };
    let config = { ...defaultConfig };
    let allPlayersData = loadAllUsers();

    let gameState = {
      isPlaying: false,
      userScore: 0,
      aiScore: 0,
      timeRemaining: MATCH_DURATION,
      coinsEarned: 0,           // not used in TON anymore, kept for compatibility
      goalsThisMatch: 0,
      selectedPlayer: null,
      ballPossession: 'user',
      energy: playerData.player_energy,
      maxEnergy: playerData.player_level >= 2 ? 150 : MAX_ENERGY
    };

    let userPlayers = [], aiPlayers = [], ball = { x:50, y:50, vx:0, vy:0 };
    let joystickActive = false, joystickDirection = { x:0, y:0 };
    let buttonStates = { kick: false, pass: false, sprint: false };
    let gameTimerInterval, lastTime = 0, animationFrameId = null;
    let adCanceled = false;

    // Preload Monetag rewarded ad
    function preloadAd() {
      if (typeof show_10656450 === 'function') {
        show_10656450({ type: 'preload', ymid: playerData.id }).catch(() => {});
      }
    }

    async function initSDK() {
      if (window.elementSdk) {
        await window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (newConfig) => {
            config = { ...defaultConfig, ...newConfig };
            updateUI();
          },
          mapToCapabilities: (cfg) => ({
            recolorables: [],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (cfg) => new Map([
            ['game_title', cfg.game_title || defaultConfig.game_title],
            ['welcome_message', cfg.welcome_message || defaultConfig.welcome_message]
          ])
        });
      }
      preloadAd(); // preload ad after SDK init
    }

    function updateUI() {
      document.getElementById('main-title').textContent = config.game_title || defaultConfig.game_title;
      document.getElementById('welcome-msg').textContent = config.welcome_message || defaultConfig.welcome_message;
    }

    function updateStatsDisplay() {
      if (!playerData) return;
      const coins = (playerData.total_coins || 0).toFixed(4);
      const gp = playerData.goal_points || 0;
      const energy = playerData.player_energy || MAX_ENERGY;
      const maxEnergy = playerData.player_level >= 2 ? 150 : MAX_ENERGY;
      const wins = playerData.wins || 0;
      const draws = playerData.draws || 0;
      const losses = playerData.losses || 0;
      const adsWatched = playerData.ads_watched || 0;
      const level = playerData.player_level || 1;
      const referralCount = playerData.referral_count || 0;

      document.getElementById('menu-coins').textContent = coins;
      document.getElementById('menu-energy').textContent = energy;
      document.getElementById('menu-wins').textContent = wins;
      document.getElementById('menu-draws').textContent = draws;
      document.getElementById('menu-losses').textContent = losses;
      document.getElementById('menu-ads').textContent = adsWatched;
      document.getElementById('menu-referrals').textContent = referralCount;
      if (document.getElementById('menu-goalpoints')) {
        document.getElementById('menu-goalpoints').textContent = gp;
      }

      document.getElementById('upgrade-balance').textContent = coins;
      if (document.getElementById('upgrade-gp')) {
        document.getElementById('upgrade-gp').textContent = gp;
      }
      document.getElementById('wallet-balance').textContent = coins;
      document.getElementById('wallet-usd').textContent = (parseFloat(coins) * TON_USD_RATE).toFixed(2);
      if (document.getElementById('wallet-gp')) {
        document.getElementById('wallet-gp').textContent = gp;
      }
      document.getElementById('player-level').textContent = level;
      const levelCost = (LEVEL_UP_BASE_COST_GP * level).toFixed(0);
      document.getElementById('level-cost').textContent = levelCost;

      if (playerData.wallet_address) {
        document.getElementById('wallet-input').value = playerData.wallet_address;
        document.getElementById('wallet-status').textContent = '‚úÖ Wallet connected';
        document.getElementById('wallet-status').className = 'text-xs mt-2 text-green-400';
        document.getElementById('btn-withdraw').disabled = false;
      }

      if (playerData.super_player_unlocked) {
        document.getElementById('btn-super-player').textContent = 'Unlocked ‚úÖ';
        document.getElementById('btn-super-player').disabled = true;
      }

      const canPlay = energy >= ENERGY_COST_PER_MATCH && joinedChannel;
      const playBtn = document.getElementById('play-btn');
      if (!canPlay) {
        if (!joinedChannel) playBtn.textContent = 'üîí Join Channel to Play';
        else playBtn.textContent = '‚ö° Low Energy - Watch Ad';
        playBtn.classList.add('opacity-75');
      } else {
        playBtn.textContent = '‚öΩ Play Match';
        playBtn.classList.remove('opacity-75');
      }

      gameState.energy = energy;
      gameState.maxEnergy = maxEnergy;

      // Update daily withdrawn display
      if (document.getElementById('daily-withdrawn')) {
        document.getElementById('daily-withdrawn').textContent = (playerData.daily_withdrawn || 0).toFixed(4);
      }
    }

    function updateReferralDisplay() {
      if (!playerData) return;
      const referralCode = playerData.referral_code || 'LOADING...';
      const referralCount = playerData.referral_count || 0;
      const referralEarnings = (playerData.referral_earnings || 0).toFixed(4);

      document.getElementById('my-referral-code').textContent = referralCode;
      document.getElementById('referral-count').textContent = referralCount;
      document.getElementById('referral-earnings').textContent = referralEarnings;

      const botUsername = 'Goal2Ton_bot';
      const referralLink = `https://t.me/${botUsername}?start=${referralCode}`;
      document.getElementById('referral-link-input').value = referralLink;

      if (playerData.referred_by) {
        document.getElementById('referral-input-section').innerHTML = `
          <div class="text-center">
            <div class="text-4xl mb-2">‚úÖ</div>
            <p class="text-green-400 font-bold">Already using code: ${playerData.referred_by}</p>
            <p class="text-xs text-gray-400 mt-2">You received bonus energy!</p>
          </div>
        `;
      }
    }

    function updateLeaderboard() {
      if (!playerData) return;
      const list = document.getElementById('leaderboard-list');
      list.innerHTML = '';
      const users = loadAllUsers();
      const topPlayers = users.sort((a,b) => (b.total_coins || 0) - (a.total_coins || 0)).slice(0,50);
      topPlayers.forEach((player, index) => {
        const isCurrentUser = player.id === playerData.id;
        const entry = document.createElement('div');
        entry.className = `leaderboard-entry flex items-center justify-between p-4 rounded-xl ${isCurrentUser ? 'bg-cyan-500/20 border-2 border-cyan-500' : 'bg-white/5'}`;
        const rankEmoji = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `#${index+1}`;
        entry.innerHTML = `
          <div class="flex items-center gap-3">
            <div class="text-2xl font-bold ${index<3?'':'text-gray-400'}">${rankEmoji}</div>
            <div>
              <div class="font-bold ${isCurrentUser?'text-cyan-400':''}">${player.username||'Player'} ${isCurrentUser?'(You)':''}</div>
              <div class="text-xs text-gray-400">${player.wins||0}W ${player.draws||0}D ${player.losses||0}L</div>
            </div>
          </div>
          <div class="text-right">
            <div class="flex items-center gap-1 justify-end">
              <svg class="ton-logo" viewBox="0 0 100 100"><circle cx="50" cy="50" r="48" fill="url(#tonGrad)"/><text x="50" y="60" text-anchor="middle" fill="white" font-size="32" font-weight="900">T</text></svg>
              <span class="font-bold text-cyan-400">${(player.total_coins||0).toFixed(4)}</span>
            </div>
            <div class="text-xs text-gray-400">‚öΩ ${player.goal_points||0} GP</div>
          </div>
        `;
        list.appendChild(entry);
      });
      const userRank = users.findIndex(u => u.id === playerData.id) + 1;
      document.getElementById('user-rank').textContent = userRank > 0 ? `#${userRank}` : '#-';
      document.getElementById('user-leaderboard-coins').textContent = (playerData.total_coins||0).toFixed(4);
    }

    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
      if (screenId === 'leaderboard-screen') updateLeaderboard();
      else if (screenId === 'referral-screen') updateReferralDisplay();
      else if (screenId === 'wallet-screen') {
        if (document.getElementById('wallet-gp')) document.getElementById('wallet-gp').textContent = playerData.goal_points || 0;
      }
    }

    async function checkAndStartGame() {
      if (!playerData) { showInlineMessage('Loading player data...', 'info'); return; }
      if (!joinedChannel) {
        showInlineMessage('Please join our Telegram channel first!', 'warning');
        document.getElementById('join-channel-banner').classList.remove('hidden');
        return;
      }
      if (gameState.energy < ENERGY_COST_PER_MATCH) {
        showInlineMessage('Not enough energy! Watch an ad or upgrade energy.', 'warning');
        return;
      }
      startGame();
    }

    function startGame() {
      try {
        gameState = {
          isPlaying: true,
          userScore: 0,
          aiScore: 0,
          timeRemaining: MATCH_DURATION,
          coinsEarned: 0,
          goalsThisMatch: 0,
          selectedPlayer: null,
          ballPossession: 'user',
          energy: gameState.energy - ENERGY_COST_PER_MATCH,
          maxEnergy: gameState.maxEnergy
        };
        const userHue = Math.floor(Math.random() * 360);
        setTimeout(() => {
          document.querySelectorAll('.player.user').forEach(el => {
            el.style.background = `linear-gradient(135deg, hsl(${userHue}, 100%, 50%), hsl(${userHue}, 100%, 30%))`;
          });
        }, 100);
        showScreen('game-screen');
        initializePlayers();
        resetBall();
        updateGameHUD();
        playSound('whistle');
        lastTime = performance.now();
        animationFrameId = requestAnimationFrame(gameLoop);
        gameTimerInterval = setInterval(() => {
          if (gameState.isPlaying && gameState.timeRemaining > 0) {
            gameState.timeRemaining -= 1;
            updateGameHUD();
            if (gameState.timeRemaining <= 0) endGame();
          }
        }, 1000);
      } catch (error) {
        console.error('Error starting game:', error);
        showInlineMessage('Error starting game. Please refresh.', 'error');
      }
    }

    function initializePlayers() { /* unchanged */ }
    function selectPlayer(index, team) { if (team !== 'user') return; userPlayers.forEach((p,i) => p.el.classList.toggle('selected', i===index)); gameState.selectedPlayer = index; }
    function selectNearestPlayer() { let nearestIdx=0, nearestDist=Infinity; userPlayers.forEach((p,i) => { const d = Math.hypot(p.x-ball.x, p.y-ball.y); if (d<nearestDist) { nearestDist=d; nearestIdx=i; } }); selectPlayer(nearestIdx,'user'); }
    function resetBall() { ball = {x:50,y:50,vx:0,vy:0}; updateBallPosition(); }
    function updateBallPosition() { document.getElementById('ball').style.left = ball.x+'%'; document.getElementById('ball').style.top = ball.y+'%'; }

    function gameLoop(timestamp) { /* unchanged - see previous version */ }
    function updateUserTeam() { /* unchanged */ }
    function updateAI() { /* unchanged */ }
    function checkGoals() { /* unchanged */ }

    function scoreGoal(team) {
      gameState.isPlaying = false;
      if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; }
      showVARReview(() => {
        if (team === 'user') {
          gameState.userScore++;
          gameState.goalsThisMatch++;
          playerData.goal_points = (playerData.goal_points || 0) + GOAL_GP;
          updateUser(playerData);
          sendToBot('goal_scored', { match_id: Date.now(), goal_number: gameState.goalsThisMatch, gp_earned: GOAL_GP });
          playSound('goal');
          showCelebration();
        } else {
          gameState.aiScore++;
          playSound('whistle');
        }
        updateGameHUD();
        setTimeout(() => {
          initializePlayers();
          resetBall();
          gameState.ballPossession = team === 'user' ? 'ai' : 'user';
          gameState.isPlaying = true;
          lastTime = performance.now();
          animationFrameId = requestAnimationFrame(gameLoop);
          playSound('whistle');
        }, team === 'user' ? 3000 : 1500);
      });
    }

    function showVARReview(callback) { /* unchanged */ }
    function showCelebration() { /* unchanged */ }

    function shootBall(team) {
      gameState.ballPossession = 'none';
      playSound('kick');
      if (team === 'user') {
        const currentPlayer = userPlayers[gameState.selectedPlayer];
        const accuracyBonus = currentPlayer.isSuper ? 10 : (playerData?.player_level || 1) * 2;
        const aimX = 50 + (Math.random() - 0.5) * (20 - accuracyBonus);
        const dx = (aimX - currentPlayer.x) * 0.15;
        const powerBonus = currentPlayer.isSuper ? 3 : 0;
        ball.vx = dx; ball.vy = -12 - powerBonus;
      } else {
        const aimX = 50 + (Math.random() - 0.5) * 25;
        const aiAttacker = aiPlayers[9];
        const dx = (aimX - aiAttacker.x) * 0.1;
        ball.vx = dx; ball.vy = 8;
      }
    }

    function passBall() {
      if (gameState.ballPossession !== 'user') return;
      playSound('pass');
      let nearestIdx = -1, nearestDist = Infinity;
      const currentPlayer = userPlayers[gameState.selectedPlayer];
      const passDirection = { x: joystickDirection.x, y: joystickDirection.y };
      const hasPressDirection = Math.abs(passDirection.x) > 0.1 || Math.abs(passDirection.y) > 0.1;
      userPlayers.forEach((p,i) => {
        if (i === gameState.selectedPlayer) return;
        const dx = p.x - currentPlayer.x, dy = p.y - currentPlayer.y, dist = Math.hypot(dx,dy);
        if (hasPressDirection) {
          const dotProduct = (dx * passDirection.x + dy * passDirection.y) / dist;
          if (dotProduct > 0.5 && dist < 50 && dist < nearestDist) { nearestDist = dist; nearestIdx = i; }
        } else {
          if (dist < nearestDist && dist < 40) { nearestDist = dist; nearestIdx = i; }
        }
      });
      if (nearestIdx >= 0) {
        const target = userPlayers[nearestIdx];
        gameState.ballPossession = 'none';
        ball.vx = (target.x - ball.x) * 0.2;
        ball.vy = (target.y - ball.y) * 0.2;
        setTimeout(() => { if (gameState.ballPossession === 'user') selectPlayer(nearestIdx,'user'); }, 300);
      }
    }

    function updateGameHUD() {
      document.getElementById('user-score').textContent = gameState.userScore;
      document.getElementById('ai-score').textContent = gameState.aiScore;
      document.getElementById('game-coins').textContent = playerData.total_coins.toFixed(4);
      const mins = Math.floor(gameState.timeRemaining/60);
      const secs = gameState.timeRemaining%60;
      document.getElementById('game-timer').textContent = `${mins}:${secs.toString().padStart(2,'0')}`;
      const energyPercent = (gameState.energy / gameState.maxEnergy) * 100;
      document.getElementById('energy-bar').style.width = energyPercent + '%';
      document.getElementById('energy-text').textContent = gameState.energy;
    }

    async function endGame() {
      gameState.isPlaying = false;
      clearInterval(gameTimerInterval);
      if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; }
      let result = '';
      if (gameState.userScore > gameState.aiScore) {
        playerData.goal_points = (playerData.goal_points || 0) + WIN_BONUS_GP;
        result = 'win';
        document.getElementById('gameover-title').textContent = 'VICTORY! üèÜ';
        document.getElementById('goal-title').textContent = 'VICTORY!';
        playSound('goal');
      } else if (gameState.userScore < gameState.aiScore) {
        result = 'loss';
        document.getElementById('gameover-title').textContent = 'DEFEAT üò¢';
      } else {
        result = 'draw';
        document.getElementById('gameover-title').textContent = 'DRAW ü§ù';
      }
      playSound('whistle');
      document.getElementById('final-user-score').textContent = gameState.userScore;
      document.getElementById('final-ai-score').textContent = gameState.aiScore;
      document.getElementById('earned-coins').textContent = (gameState.coinsEarned).toFixed(4); // kept for display
      document.getElementById('match-goals').textContent = gameState.goalsThisMatch;
      if (gameState.energy < ENERGY_COST_PER_MATCH) document.getElementById('ad-unlock-notice').classList.remove('hidden');
      else document.getElementById('ad-unlock-notice').classList.add('hidden');
      document.getElementById('gameover-overlay').classList.add('active');
      await saveStats(result);
      sendToBot('match_end', { result, user_score: gameState.userScore, ai_score: gameState.aiScore, gp_earned: gameState.goalsThisMatch * GOAL_GP + (result==='win'?WIN_BONUS_GP:0) });
      preloadAd(); // preload next ad
    }

    async function saveStats(result) {
      if (!playerData) return;
      playerData.goals_scored = (playerData.goals_scored || 0) + gameState.goalsThisMatch;
      playerData.games_played = (playerData.games_played || 0) + 1;
      playerData.wins = (playerData.wins || 0) + (result === 'win' ? 1 : 0);
      playerData.losses = (playerData.losses || 0) + (result === 'loss' ? 1 : 0);
      playerData.draws = (playerData.draws || 0) + (result === 'draw' ? 1 : 0);
      playerData.high_score = Math.max(playerData.high_score || 0, gameState.userScore);
      playerData.player_energy = gameState.energy;
      playerData.last_played = new Date().toISOString();
      updateUser(playerData);
    }

    // Updated ad reward: GP bonus + energy restore
    function showAdReward() {
      document.getElementById('gameover-overlay').classList.remove('active');
      document.getElementById('ad-screen').classList.add('active');
      adCanceled = false;
      let timeLeft = AD_DURATION;
      const timerEl = document.getElementById('ad-timer');
      const progressEl = document.getElementById('ad-progress');
      const adInterval = setInterval(() => {
        if (adCanceled) { clearInterval(adInterval); return; }
        timeLeft--;
        timerEl.textContent = timeLeft;
        progressEl.style.width = ((AD_DURATION - timeLeft) / AD_DURATION * 100) + '%';
        if (timeLeft <= 0) clearInterval(adInterval);
      }, 1000);
      if (typeof show_10656450 === 'function') {
        show_10656450({ ymid: playerData.id }).then(() => {
          if (!adCanceled) { clearInterval(adInterval); completeAdReward(); }
        }).catch(e => {
          if (!adCanceled) { clearInterval(adInterval); document.getElementById('ad-screen').classList.remove('active'); showInlineMessage('Ad not completed. Try again.', 'warning'); }
        });
      } else {
        setTimeout(() => { if (!adCanceled) { clearInterval(adInterval); completeAdReward(); } }, AD_DURATION * 1000);
      }
    }

    function cancelAd() {
      adCanceled = true;
      document.getElementById('ad-screen').classList.remove('active');
      showScreen('menu-screen');
    }

    async function completeAdReward() {
      if (!playerData) return;
      const energyRestore = 20;
      const newEnergy = Math.min(gameState.maxEnergy, (playerData.player_energy || MAX_ENERGY) + energyRestore);
      playerData.goal_points = (playerData.goal_points || 0) + AD_GP_BONUS;
      playerData.ads_watched = (playerData.ads_watched || 0) + 1;
      playerData.player_energy = newEnergy;
      updateUser(playerData);
      document.getElementById('ad-screen').classList.remove('active');
      showScreen('menu-screen');
      showInlineMessage(`üéÅ +${AD_GP_BONUS} GP & +${energyRestore} Energy earned!`, 'success');
      playSound('coin');
      sendToBot('ad_watched', { gp_bonus: AD_GP_BONUS, energy_restore: energyRestore });
      preloadAd(); // preload next ad
    }

    // Upgrade functions now use GP
    async function upgradeEnergy() {
      if (!playerData) { showInlineMessage('Player data not loaded', 'error'); return; }
      if ((playerData.goal_points || 0) < ENERGY_BOOST_COST_GP) { showInlineMessage('Not enough GP!', 'error'); return; }
      if (playerData.player_level >= 2) { showInlineMessage('Already upgraded!', 'warning'); return; }
      playerData.goal_points -= ENERGY_BOOST_COST_GP;
      playerData.player_level = 2;
      playerData.player_energy = 150;
      updateUser(playerData);
      showInlineMessage('‚ö° Energy upgraded to 150!', 'success');
      document.getElementById('btn-upgrade-energy').textContent = 'Upgraded ‚úÖ';
      document.getElementById('btn-upgrade-energy').disabled = true;
      sendToBot('upgrade', { type: 'energy' });
      updateStatsDisplay();
    }

    async function upgradeLevel() {
      if (!playerData) { showInlineMessage('Player data not loaded', 'error'); return; }
      const level = playerData.player_level || 1;
      const cost = LEVEL_UP_BASE_COST_GP * level;
      if ((playerData.goal_points || 0) < cost) { showInlineMessage('Not enough GP!', 'error'); return; }
      playerData.goal_points -= cost;
      playerData.player_level = level + 1;
      updateUser(playerData);
      showInlineMessage(`üéØ Player upgraded to Level ${level+1}!`, 'success');
      sendToBot('upgrade', { type: 'skill', new_level: level+1 });
      updateStatsDisplay();
    }

    async function unlockSuperPlayer() {
      if (!playerData) { showInlineMessage('Player data not loaded', 'error'); return; }
      if (playerData.super_player_unlocked) { showInlineMessage('Already unlocked!', 'warning'); return; }
      if ((playerData.goal_points || 0) < SUPER_PLAYER_COST_GP) { showInlineMessage('Not enough GP!', 'error'); return; }
      playerData.goal_points -= SUPER_PLAYER_COST_GP;
      playerData.super_player_unlocked = true;
      updateUser(playerData);
      showInlineMessage('‚≠ê Super Player unlocked!', 'success');
      document.getElementById('super-locked').classList.remove('hidden');
      sendToBot('upgrade', { type: 'super_player' });
      updateStatsDisplay();
    }

    // Wallet & Convert functions
    function showConvertModal() {
      document.getElementById('convert-modal').classList.add('active');
      document.getElementById('convert-gp-balance').textContent = playerData.goal_points || 0;
      document.getElementById('convert-amount').value = '';
      document.getElementById('convert-message').classList.add('hidden');
    }

    function closeConvertModal() {
      document.getElementById('convert-modal').classList.remove('active');
    }

    function setMaxConvert() {
      const gp = playerData.goal_points || 0;
      const max = Math.floor(gp / 1000) * 1000;
      document.getElementById('convert-amount').value = max;
    }

    async function processConvert() {
      const amount = parseInt(document.getElementById('convert-amount').value);
      const gp = playerData.goal_points || 0;
      const msgEl = document.getElementById('convert-message');
      if (!amount || amount < 1000 || amount % 1000 !== 0) {
        msgEl.className = 'mt-4 p-3 rounded-lg bg-red-500/20 text-red-400';
        msgEl.textContent = '‚ùå Amount must be multiples of 1000 GP (min 1000)';
        msgEl.classList.remove('hidden');
        return;
      }
      if (amount > gp) {
        msgEl.className = 'mt-4 p-3 rounded-lg bg-red-500/20 text-red-400';
        msgEl.textContent = '‚ùå Insufficient GP';
        msgEl.classList.remove('hidden');
        return;
      }
      const tonEarned = (amount / 1000) * 0.01;
      playerData.goal_points = gp - amount;
      playerData.total_coins = (playerData.total_coins || 0) + tonEarned;
      updateUser(playerData);
      msgEl.className = 'mt-4 p-3 rounded-lg bg-green-500/20 text-green-400';
      msgEl.textContent = `‚úÖ Converted ${amount} GP to ${tonEarned.toFixed(4)} TON!`;
      playSound('coin');
      sendToBot('convert', { gp: amount, ton: tonEarned });
      setTimeout(() => { closeConvertModal(); updateStatsDisplay(); }, 2000);
    }

    async function saveWalletAddress() { /* unchanged */ }

    function showWithdrawModal() {
      if (!playerData?.wallet_address) { showInlineMessage('Please add your wallet address first', 'warning'); return; }
      document.getElementById('withdraw-modal').classList.add('active');
      document.getElementById('withdraw-balance').textContent = (playerData?.total_coins || 0).toFixed(4);
      document.getElementById('withdraw-amount').value = '';
      document.getElementById('withdraw-message').classList.add('hidden');
    }

    function closeWithdrawModal() {
      document.getElementById('withdraw-modal').classList.remove('active');
    }

    function setMaxWithdraw() {
      const balance = playerData?.total_coins || 0;
      const fee = WITHDRAW_FEE;
      const dailyLeft = Math.max(0, DAILY_LIMIT_TON - (playerData.daily_withdrawn || 0));
      const maxPossible = Math.min(balance - fee, dailyLeft);
      document.getElementById('withdraw-amount').value = maxPossible > 0 ? maxPossible.toFixed(4) : 0;
    }

    async function processWithdraw() {
      const amount = parseFloat(document.getElementById('withdraw-amount').value);
      const balance = playerData?.total_coins || 0;
      const msgEl = document.getElementById('withdraw-message');
      const today = new Date().toDateString();
      if (playerData.last_withdraw_date !== today) {
        playerData.daily_withdrawn = 0;
        playerData.last_withdraw_date = today;
      }
      const dailyLeft = Math.max(0, DAILY_LIMIT_TON - (playerData.daily_withdrawn || 0));
      msgEl.classList.remove('hidden');
      if (!amount || amount < MIN_WITHDRAW_TON) {
        msgEl.className = 'mt-4 p-3 rounded-lg bg-red-500/20 text-red-400';
        msgEl.textContent = `‚ùå Minimum withdrawal is ${MIN_WITHDRAW_TON} TON`;
        return;
      }
      if (amount > dailyLeft) {
        msgEl.className = 'mt-4 p-3 rounded-lg bg-red-500/20 text-red-400';
        msgEl.textContent = `‚ùå Daily limit exceeded. You can withdraw up to ${dailyLeft.toFixed(4)} TON today.`;
        return;
      }
      if (amount + WITHDRAW_FEE > balance) {
        msgEl.className = 'mt-4 p-3 rounded-lg bg-red-500/20 text-red-400';
        msgEl.textContent = '‚ùå Insufficient balance (including fee)';
        return;
      }
      playerData.total_coins = balance - amount - WITHDRAW_FEE;
      playerData.daily_withdrawn = (playerData.daily_withdrawn || 0) + amount;
      updateUser(playerData);
      msgEl.className = 'mt-4 p-3 rounded-lg bg-green-500/20 text-green-400';
      msgEl.textContent = `‚úÖ Withdrawal request submitted! ${amount.toFixed(4)} TON will be sent to your wallet within 24 hours.`;
      playSound('coin');
      sendToBot('withdraw_request', { amount, address: playerData.wallet_address, fee: WITHDRAW_FEE });
      setTimeout(() => { closeWithdrawModal(); showScreen('menu-screen'); }, 3000);
    }

    // Referral submission with validation against incomingReferrerId
    async function submitReferralCode() {
      if (!playerData) return;
      if (playerData.referred_by) { showInlineMessage('You already used a referral code!', 'warning'); return; }
      const inputCode = document.getElementById('referral-code-input').value.trim().toUpperCase();
      if (!inputCode || inputCode.length < 5) { showInlineMessage('‚ùå Invalid code format!', 'error'); return; }
      if (inputCode === playerData.referral_code) { showInlineMessage('‚ùå Cannot use your own code!', 'error'); return; }

      // If there is an incoming referrer, the submitted code must match it exactly
      if (incomingReferrerId && inputCode !== incomingReferrerId) {
        showInlineMessage('‚ùå This code does not match the one that invited you.', 'error');
        return;
      }

      const referrer = getUserById(inputCode);
      if (!referrer) { showInlineMessage('‚ùå Code not found!', 'error'); return; }

      const bonusEnergy = REFERRAL_ENERGY;
      const newEnergy = Math.min(gameState.maxEnergy, (playerData.player_energy || MAX_ENERGY) + bonusEnergy);
      playerData.referred_by = inputCode;
      playerData.player_energy = newEnergy;
      updateUser(playerData);

      referrer.referral_count = (referrer.referral_count || 0) + 1;
      referrer.referral_earnings = (referrer.referral_earnings || 0) + REFERRAL_TON;
      referrer.total_coins = (referrer.total_coins || 0) + REFERRAL_TON;
      updateUser(referrer);

      showInlineMessage(`‚úÖ Code applied! +${bonusEnergy} Energy & referrer got ${REFERRAL_TON.toFixed(4)} TON!`, 'success');
      document.getElementById('referral-code-input').value = '';
      sendToBot('referral_used', { referrer_code: inputCode, referrer_id: referrer.id, bonus_energy: bonusEnergy, reward: REFERRAL_TON });
      updateStatsDisplay();
    }

    // Copy functions, shareToTelegram, showInlineMessage, initControls unchanged

    function initControls() { /* unchanged */ }

    document.addEventListener('DOMContentLoaded', function() {
      initSDK().then(() => {
        initControls();
        updateUI();
        updateStatsDisplay();
        updateLeaderboard();
        updateReferralDisplay();
        playBackgroundMusic();
      });
    });
  </script>
 </body>
</html>